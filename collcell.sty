
\newtoks\collect@cell@toks

\def\endcollect@cell{\@gobble{endcollect@cell}}

\def\collect@cell#1#2\ignorespaces{%
  \collect@cell@toks{}%
  \let\collect@cell@spaces\empty
  \def\collect@cell@end{%
    \expandafter\scantokens\expandafter
    {\expandafter#1\expandafter{\the\collect@cell@toks}}%
  }
  \def\collect@cell@next{\collect@cell@look}%
  \collect@cell@next
}

\def\collect@cell@look{%
  \futurelet\collect@cell@lettoken\collect@cell@look@
}

\def\:{\collect@cell@eatspace}
\expandafter\def\: {\collect@cell@look}

\def\collect@cell@look@{%
  \ifx\collect@cell@lettoken\@sptoken
    \edef\collect@cell@spaces{\collect@cell@spaces\space}%
    \def\collect@cell@next{\collect@cell@eatspace}%
  \else
    \ifx\collect@cell@lettoken\bgroup
      \def\collect@cell@next{\collect@cell@group}%
    \else
      \def\collect@cell@next{\collect@cell@arg}%
    \fi
  \fi
  \collect@cell@next
}

\def\collect@cell@group#1{%
  \begingroup
  \def\@tempa{#1}%
  \def\@tempb{\bgroup}%
  \ifx\@tempa\@tempb
    \endgroup
    \def\collect@cell@next{\collect@cell@arg\bgroup}%
  \else
    \endgroup
    \def\collect@cell@next{\collect@cell@arg{{#1}}}%
  \fi
  \collect@cell@next
}

\def\collect@cell@addarg#1{%
  \expandafter\expandafter\expandafter\collect@cell@toks
  \expandafter\expandafter\expandafter
  {\expandafter\the\expandafter\collect@cell@toks\collect@cell@spaces#1}%
  \let\collect@cell@spaces\empty
}

\def\collect@cell@arg#1{%
  \ifx\collect@cell@lettoken\\
    \def\collect@cell@next{\collect@cell@end#1}%
  \else
    \ifx\collect@cell@lettoken\unskip
      \def\collect@cell@next{%
        \@ifnextchar\endcollect@cell
          {\collect@cell@end#1}%
          {\collect@cell@addarg{#1}\collect@cell@look}%
      }%
    \else
      \collect@cell@addarg{#1}%
      \def\collect@cell@next{\collect@cell@look}%
    \fi
  \fi
  \collect@cell@next
}

